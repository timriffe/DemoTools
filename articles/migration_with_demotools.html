<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Migration models with DemoTools • DemoTools</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/yeti/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Migration models with DemoTools">
<meta property="og:description" content="DemoTools">
<meta property="og:image" content="https://timriffe.github.io/DemoTools/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-reverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">DemoTools</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">01.13.61</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Short manuals
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Age-heaping_quality_with_Demotools.html">Handle age heaping</a>
    </li>
    <li>
      <a href="../articles/graduation_with_demotools.html">Graduate demographic counts</a>
    </li>
    <li>
      <a href="../articles/smoothing_with_demotools.html">Smooth demographic counts</a>
    </li>
    <li>
      <a href="../articles/lifetables_with_demotools.html">Construct a lifetable</a>
    </li>
    <li>
      <a href="../articles/migration_with_demotools.html">Model migration</a>
    </li>
  </ul>
</li>
<li>
  <a href="../articles/case_study_1.html">Case study</a>
</li>
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://twitter.com/timriffe1">
    <span class="fa fa-twitter"></span>
     
  </a>
</li>
<li>
  <a href="https://github.com/timriffe/DemoTools/">
    <span class="fa fa-github fa-lg"></span>
     
    github
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="migration_with_demotools_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Migration models with DemoTools</h1>
                        <h4 class="author">José Manuel Aburto, Ilya Kashnitsky, Monica Alexander, Jorge Cimentada, Tim Riffe</h4>
            
            <h4 class="date">2021-07-14</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/timriffe/DemoTools/blob/master/vignettes/migration_with_demotools.Rmd"><code>vignettes/migration_with_demotools.Rmd</code></a></small>
      <div class="hidden name"><code>migration_with_demotools.Rmd</code></div>

    </div>

    
    
<div id="why-model-migration" class="section level2">
<h2 class="hasAnchor">
<a href="#why-model-migration" class="anchor"></a>Why model migration</h2>
<p>Migration happens with multiple transitions over the life course such as entry to education, new job or retirement <span class="citation">(Preston, Heuveline, and Guillot 2000)</span>. These transitions happen more frequently at some ages and come in parallel often with migration. Adult migration usually peaks at young adult ages. Around age at retirement there is a second peak. Because of these regularities it is, therefore, possible to model migration by age, which is very important for policy makers and for demographers in estimating population dynamics. Age-specific migration models can help to estimate missing data, smooth noisy data, project trends into the future, and to generalize migration patterns across different populations.</p>
<p><code>DemoTools</code> has the functionality to fit and estimate age-specific migration schedules based on the Rogers-Castro migration model. This vignette briefly introduces the Rogers-Castro model and then gives examples of both calculating age-specific migration curves given a set of parameters, and fitting the Rogers-Castro model given a set of age-specific migration rates.</p>
</div>
<div id="the-rogers-and-castro-model" class="section level2">
<h2 class="hasAnchor">
<a href="#the-rogers-and-castro-model" class="anchor"></a>The Rogers and Castro model</h2>
<p><span class="citation">Rogers and Castro (1981)</span> developed a mathematical model of migration with up to 13 parameters. Seven of these parameters explain the shape of migration by age, while the rest of parameters represent the intensity of migration. The original formula for the migration rate at age <span class="math inline">\(x\)</span> is:</p>
<p><span class="math display">\[\begin{equation*}
m(x)= a_1 \exp{[ \alpha_1 x ]} + a_2 \exp{[ -\alpha_2 (x - \mu_2) - \exp{ [ -\lambda_2(x - \mu_2) ]}  ]}+ a_3 \exp{[ - \alpha_3(x-\mu_3) - \exp{[-\lambda_3 (x-\mu_3)]} ]} + a_4\exp{[\lambda_4x ]}+ c
\end{equation*}\]</span></p>
<p>The <span class="math inline">\(c\)</span> parameter describes the baseline level of migration. There are four other distinct parts to the equation, which each describe the shape and intensity of migration at different ages:</p>
<ul>
<li>pre-working age: <span class="math inline">\(a_1 \exp{[ \alpha_1 x ]}\)</span> (Group 1)</li>
<li>working age: <span class="math inline">\(a_2 \exp{[ -\alpha_2 (x - \mu_2) - \exp{ [ -\lambda_2(x - \mu_2) ]} ]}\)</span> (Group 2)</li>
<li>retirement age: <span class="math inline">\(a_3 \exp{[ - \alpha_3(x-\mu_3) - \exp{[-\lambda_3 (x-\mu_3)]} ]}\)</span> (Group 3)</li>
<li>post-retirement age: <span class="math inline">\(a_4 \exp{[\lambda_4x ]}\)</span> (Group 4)</li>
</ul>
<p>For each of the components, the <span class="math inline">\(a_k\)</span> terms describe the heights of the peaks of migration rates. The <span class="math inline">\(\alpha_k\)</span> and <span class="math inline">\(\lambda_k\)</span> parameters describe the shape of each of the components, in terms of the rate of change over age. And <span class="math inline">\(\mu_2\)</span> and <span class="math inline">\(\mu_3\)</span> give the ages at the labour force peak and at the retirement peak, respectively.</p>
<p>The migration model need not have all the ‘families’ of migration at different age stages. In practice, there are four combinations of families that are the most common <span class="citation">(Rogers, Little, and Raymer 2010)</span>:</p>
<ul>
<li>The 7 parameter model, which has the pre-working and working age components</li>
<li>The 9 parameter model, which has the pre-working, working and post-retirement age components</li>
<li>The 11 parameter model, which has the pre-working, working and retirement age components</li>
<li>The 13 parameter model, which has all components.</li>
</ul>
<p>The migration model-related functions in <code>DemoTools</code> allow for any combination of the components to be included in the model.</p>
</div>
<div id="examples-with-demotools" class="section level2">
<h2 class="hasAnchor">
<a href="#examples-with-demotools" class="anchor"></a>Examples with <code>DemoTools</code>
</h2>
<p><code>DemoTools</code> includes two migration model-related functions: <code>mig_calculate_rc</code>, which returns age-specific migration rates calculated based on an age range and set of parameter inputs, and <code>mig_estimate_rc</code>, which estimates parameter values and age-specific migration rates <span class="math inline">\(m(x)\)</span> based on an observed age range and migration rates. This section gives examples of both functions.</p>
<div id="calculating-rogers-castro-migration-schedules" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-rogers-castro-migration-schedules" class="anchor"></a>Calculating Rogers-Castro migration schedules</h3>
<p>We can calculate the implied age-specific rates from a set of parameter inputs. Parameters are defined the same way as in the equation above, that is, <code>c</code> is the overall intensity, the <code>a</code>’s are the intensities at each age family, the <code>alpha</code>s and <code>lambda</code>s are the rate of decrease and increase of the shape at each age family, and the <code>mu</code>s are the age of peak migration for working age and retirement.</p>
<p>The following is an example specifying values for each of the 13 possible parameters, with values calculated for each age up to age 100:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">DemoTools</span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>

<span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>a1<span class="op">=</span> <span class="fl">0.09</span>, alpha1<span class="op">=</span> <span class="fl">0.1</span>,
          a2<span class="op">=</span> <span class="fl">0.2</span>, alpha2<span class="op">=</span> <span class="fl">0.1</span>, mu2<span class="op">=</span> <span class="fl">21</span>, lambda2<span class="op">=</span> <span class="fl">0.4</span>,
          a3<span class="op">=</span> <span class="fl">0.02</span>, alpha3<span class="op">=</span> <span class="fl">0.25</span>, mu3<span class="op">=</span> <span class="fl">67</span>, lambda3<span class="op">=</span> <span class="fl">0.6</span>,
          a4 <span class="op">=</span> <span class="fl">0.01</span>, lambda4 <span class="op">=</span> <span class="fl">0.01</span>,
          c<span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>

<span class="va">ages</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>
<span class="va">mx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mig_calculate_rc.html">mig_calculate_rc</a></span><span class="op">(</span>ages <span class="op">=</span> <span class="va">ages</span>, pars <span class="op">=</span> <span class="va">pars</span><span class="op">)</span>

<span class="co"># plot to see what the schedule looks like</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>age <span class="op">=</span> <span class="va">ages</span>, mx <span class="op">=</span> <span class="va">mx</span><span class="op">)</span>
<span class="va">df</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">mx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Rogers-Castro age-specific migration schedule (13-parameter)"</span><span class="op">)</span></code></pre></div>
<p><img src="migration_with_demotools_files/figure-html/unnamed-chunk-1-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Not all parameters need to be specified. The following shows an example of the 9 parameter specification:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>a1<span class="op">=</span> <span class="fl">0.09</span>, alpha1<span class="op">=</span> <span class="fl">0.1</span>,
          a2<span class="op">=</span> <span class="fl">0.2</span>, alpha2<span class="op">=</span> <span class="fl">0.05</span>, mu2<span class="op">=</span> <span class="fl">25</span>, lambda2<span class="op">=</span> <span class="fl">0.4</span>,
          c<span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span>

<span class="va">ages</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">100</span>
<span class="va">mx</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mig_calculate_rc.html">mig_calculate_rc</a></span><span class="op">(</span>ages <span class="op">=</span> <span class="va">ages</span>, pars <span class="op">=</span> <span class="va">pars</span><span class="op">)</span>

<span class="co"># plot to see what the schedule looks like</span>
<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>age <span class="op">=</span> <span class="va">ages</span>, mx <span class="op">=</span> <span class="va">mx</span><span class="op">)</span>
<span class="va">df</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">mx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Rogers-Castro age-specific migration schedule (9-parameter)"</span><span class="op">)</span></code></pre></div>
<p><img src="migration_with_demotools_files/figure-html/unnamed-chunk-2-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Note, however, that all parameters within a particular component family must be specified. So for example, if one of the working-age family parameters is specified (Group 2), then all must be specified, otherwise an error occurs.</p>
</div>
<div id="estimating-migration-age-schedules-using-the-rogers-castro-model" class="section level3">
<h3 class="hasAnchor">
<a href="#estimating-migration-age-schedules-using-the-rogers-castro-model" class="anchor"></a>Estimating migration age schedules using the Rogers-Castro model</h3>
<div id="overview" class="section level4">
<h4 class="hasAnchor">
<a href="#overview" class="anchor"></a>Overview</h4>
<p>The <code>mig_estimate_rc</code> function returns estimated Rogers-Castro parameters and <span class="math inline">\(m(x)\)</span> values, based on observed age-specific mortality rates, and age range, and the Rogers-Castro components to be included in the model. The function has the capability of estimating a Rogers-Castro age schedule with any combination of the components <code>pre_working_age</code>, <code>working_age</code>, <code>retirement</code> and <code>post_retirement</code>. These are specified as logicals (either <code>TRUE</code> or <code>FALSE</code>) in the function.</p>
<p>As illustrated above, Rogers-Castro migration age schedules are highly non-linear, as so are not necessarily straight forward to estimate. Previous approaches have used, for example, Excel’s Solver function or the <code>optim</code> function in <code>R</code>.<a href="#fn1" class="footnote-ref" id="fnref1"><sup>1</sup></a> However, the estimated parameters and schedules are highly sensitive to the initial values chosen for the parameter values, and convergence is difficult to achieve for the 11 and 13 parameter models.</p>
<p>In <code>DemoTools</code>, we estimate Rogers-Castro schedules in a Bayesian framework using a Markov Chain Monte Carlo (MCMC) algorithm, via the Stan programming language <span class="citation">(Carpenter et al. 2017)</span>. The use of Bayesian methods allows for priors to be set on parameters, which helps convergence in the estimation process.</p>
</div>
<div id="example-estimating-migration-rates-for-population-with-large-retirement-peak" class="section level4">
<h4 class="hasAnchor">
<a href="#example-estimating-migration-rates-for-population-with-large-retirement-peak" class="anchor"></a>Example: Estimating migration rates for population with large retirement peak</h4>
<p>In this example, we will fill an 11-parameter model to a set of observed age-specific rates from a population that resembles Florida in the United States. First, we can plot the observed rates to get a sense of what the age schedule looks like</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">ages</span> <span class="op">&lt;-</span> <span class="fl">0</span><span class="op">:</span><span class="fl">80</span>
<span class="va">mx_FL</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.02345</span>, <span class="fl">0.02195</span>,    <span class="fl">0.0212</span>, <span class="fl">0.02185</span>,    <span class="fl">0.02095</span>,    <span class="fl">0.02075</span>,    <span class="fl">0.0198</span>, <span class="fl">0.02065</span>,    <span class="fl">0.01815</span>,    <span class="fl">0.01865</span>,
<span class="fl">0.01945</span>,    <span class="fl">0.02165</span>,    <span class="fl">0.0224</span>, <span class="fl">0.02255</span>,    <span class="fl">0.02665</span>,    <span class="fl">0.02875</span>,    <span class="fl">0.02915</span>,    <span class="fl">0.03335</span>,    <span class="fl">0.0355</span>, <span class="fl">0.03755</span>,
<span class="fl">0.0404</span>, <span class="fl">0.0411</span>, <span class="fl">0.04205</span>,    <span class="fl">0.04355</span>,    <span class="fl">0.04275</span>,    <span class="fl">0.0423</span>, <span class="fl">0.04075</span>,    <span class="fl">0.0387</span>, <span class="fl">0.0392</span>, <span class="fl">0.0374</span>,
<span class="fl">0.0336</span>, <span class="fl">0.03185</span>,    <span class="fl">0.02975</span>,    <span class="fl">0.0295</span>, <span class="fl">0.02855</span>,    <span class="fl">0.02685</span>,    <span class="fl">0.0251</span>, <span class="fl">0.0246</span>, <span class="fl">0.02425</span>,    <span class="fl">0.0241</span>,
<span class="fl">0.02285</span>,    <span class="fl">0.02165</span>,    <span class="fl">0.0236</span>, <span class="fl">0.02085</span>,    <span class="fl">0.02145</span>,    <span class="fl">0.0204</span>, <span class="fl">0.02025</span>,    <span class="fl">0.02125</span>,    <span class="fl">0.0229</span>, <span class="fl">0.01985</span>,
<span class="fl">0.0234</span>, <span class="fl">0.02175</span>,    <span class="fl">0.02185</span>,    <span class="fl">0.02385</span>,    <span class="fl">0.0248</span>, <span class="fl">0.0259</span>, <span class="fl">0.02545</span>,    <span class="fl">0.0271</span>, <span class="fl">0.02605</span>,    <span class="fl">0.0277</span>,
<span class="fl">0.0296</span>, <span class="fl">0.0278</span>, <span class="fl">0.02945</span>,    <span class="fl">0.0288</span>, <span class="fl">0.02775</span>,    <span class="fl">0.0296</span>, <span class="fl">0.02615</span>,    <span class="fl">0.0234</span>, <span class="fl">0.0259</span>, <span class="fl">0.02635</span>,
<span class="fl">0.0256</span>, <span class="fl">0.0248</span>, <span class="fl">0.0221</span>, <span class="fl">0.0234</span>, <span class="fl">0.0233</span>, <span class="fl">0.02245</span>,    <span class="fl">0.02235</span>,    <span class="fl">0.0212</span>, <span class="fl">0.02075</span>,    <span class="fl">0.01915</span>,
<span class="fl">0.01995</span><span class="op">)</span>

<span class="va">df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span>age <span class="op">=</span> <span class="va">ages</span>, mx <span class="op">=</span> <span class="va">mx_FL</span><span class="op">)</span>
<span class="va">df</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">age</span>, <span class="va">mx</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Observed migration rates"</span><span class="op">)</span></code></pre></div>
<p><img src="migration_with_demotools_files/figure-html/unnamed-chunk-4-1.png" width="576" style="display: block; margin: auto;"></p>
<p>Let’s fit a Rogers-Castro migration age schedule to these data. Below, we choose to estimate parameters associated with the pre-working age, working and retirement components (but not post retirement).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">rc_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mig_estimate_rc.html">mig_estimate_rc</a></span><span class="op">(</span>
  <span class="va">ages</span>, <span class="va">mx_FL_sim</span>,
  pre_working_age <span class="op">=</span> <span class="cn">TRUE</span>,
  working_age <span class="op">=</span> <span class="cn">TRUE</span>,
  retirement <span class="op">=</span> <span class="cn">TRUE</span>,
  post_retirement <span class="op">=</span> <span class="cn">FALSE</span>,
  <span class="co"># (optional) arguments for Stan</span>
  chains <span class="op">=</span> <span class="fl">4</span>,
  iter <span class="op">=</span> <span class="fl">2000</span>,
  control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>adapt_delta <span class="op">=</span> <span class="fl">0.8</span>, max_treedepth <span class="op">=</span> <span class="fl">10</span><span class="op">)</span>
<span class="op">)</span></code></pre></div>
<p>The <code>mig_estimate_rc</code> function also allows for addition arguments that are related to the Stan model. In the example above, the values listed for <code>chains</code>, <code>iter</code>, <code>adapt_delta</code> and <code>max_treedepth</code> are the default values, so need have not been specified. However, depending on the context, it may make sense to increase the value of each of these components to ensure convergence. More details about these arguments can be found in the <code>R</code> help files for <code><a href="https://mc-stan.org/rstan/reference/stan.html">rstan::stan</a></code>, and also by referring to the <a href="https://mc-stan.org/users/documentation/">Stan documentation</a>.</p>
<p>The resulting <code>rc_res</code> object is shown below. The <code>pars_df</code> shows the median estimate and lower and upper bound of a 95% credible interval for the Rogers-Castro parameters. In this example, the working age peak was estimated to be at 25.3 years (95% CI: [23.5, 27.2]).</p>
<p>The <code>fit_df</code> object in <code>rc_res</code> shows the data and estimated median <span class="math inline">\(m(x)\)</span> values at each age <span class="math inline">\(x\)</span>, along with the lower and upper bound of the 95% credible interval of the fits, and the squared difference between data and the median estimate.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rc_res</span></code></pre></div>
<p>We can plot the observed data and estimated fit using the <code>fit_df</code> object:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">rc_res</span><span class="op">[[</span><span class="st">"fit_df"</span><span class="op">]</span><span class="op">]</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span><span class="va">ages</span>, <span class="va">data</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"data"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">age</span>, y <span class="op">=</span> <span class="va">median</span>, color <span class="op">=</span> <span class="st">"fit"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower</span>, ymax <span class="op">=</span> <span class="va">upper</span><span class="op">)</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_color_manual</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">""</span>, values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>data <span class="op">=</span> <span class="st">"red"</span>, fit <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"migration rate"</span><span class="op">)</span></code></pre></div>
</div>
<div id="comments-about-warnings" class="section level4">
<h4 class="hasAnchor">
<a href="#comments-about-warnings" class="anchor"></a>Comments about warnings</h4>
<p>When running <code>mc_estimate_rc</code> it is common to see warnings from Stan, particularly when the retirement and post-retirement families are included in the model. Warnings about divergent transitions, low ESS and maximum tree depth can often be eliminated by changing the Stan settings to have a larger <code>adapt_delta</code>, <code>iter</code> and <code>maximum_treedepth</code>, respectively. If warnings persist it is not the end of the world; the results are probably still fine. The warnings are largely a consequence of the complexity of the function being fitted and the strong correlations that exist between estimates of different parameters. Work is still on going investigating different prior set-ups to improve the efficiency of fit.</p>
</div>
</div>
</div>
<div id="references" class="section level2 unnumbered">
<h2 class="hasAnchor">
<a href="#references" class="anchor"></a>References</h2>
<div id="refs" class="references">
<div id="ref-carpenter2017stan">
<p>Carpenter, Bob, Andrew Gelman, Matthew D Hoffman, Daniel Lee, Ben Goodrich, Michael Betancourt, Marcus Brubaker, Jiqiang Guo, Peter Li, and Allen Riddell. 2017. “Stan: A Probabilistic Programming Language.” <em>Journal of Statistical Software</em> 76 (1).</p>
</div>
<div id="ref-preston2000demography">
<p>Preston, Samuel, Patrick Heuveline, and Michel Guillot. 2000. <em>Demography: Measuring and Modeling Population Processes</em>. Wiley-Blackwell.</p>
</div>
<div id="ref-rogers1981model">
<p>Rogers, Andrei, and Luis J Castro. 1981. “Model Migration Schedules.” <em>IIASA Working Papers</em>.</p>
</div>
<div id="ref-rogers2010indirect">
<p>Rogers, Andrei, Jani Little, and James Raymer. 2010. <em>The Indirect Estimation of Migration: Methods for Dealing with Irregular, Inadequate, and Missing Data</em>. Vol. 26. Springer Science &amp; Business Media.</p>
</div>
</div>
</div>
<div class="footnotes">
<hr>
<ol>
<li id="fn1"><p><a href="http://demographicestimation.iussp.org/content/multi-exponential-model-migration-schedule" class="uri">http://demographicestimation.iussp.org/content/multi-exponential-model-migration-schedule</a><a href="#fnref1" class="footnote-back">↩︎</a></p></li>
</ol>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Tim Riffe, José Manuel Aburto, Ilya Kashnitsky, Monica Alexander, Marius D. Pascariu, Sara Hertog, Sean Fennell.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
